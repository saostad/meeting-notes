# Development Docker Compose configuration
# Use this file for development and testing
# 
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# Features:
#   - Source code volume mounting for live development
#   - Debug environment variables
#   - Extended logging
#   - Development-friendly resource limits

version: '3.8'

services:
  meeting-video-tool-cpu:
    # Override build for development
    build:
      target: runtime
      args:
        PYTORCH_INDEX_URL: https://download.pytorch.org/whl/cpu
        ENABLE_GPU: false
    
    # Development volume mounts (Requirements 5.1, 5.2)
    volumes:
      - ./videos:/input:ro
      - ./output:/output
      - ./src:/app/src:ro                     # Live source code mounting
      - ./fonts:/app/fonts:ro                 # Font files
      - model-cache:/cache
      - ./tests:/app/tests:ro                 # Test files for development
    
    # Development environment configuration
    environment:
      # Debug settings
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - LOG_LEVEL=DEBUG
      
      # Development-specific settings
      - DEVELOPMENT_MODE=true
      - SKIP_MODEL_DOWNLOAD=false
    
    # Relaxed resource limits for development
    deploy:
      resources:
        limits:
          memory: 6G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'
    
    # Interactive development command
    command: ["python", "-m", "src.main", "--help"]
    
    # Enable TTY for interactive debugging
    tty: true
    stdin_open: true

  meeting-video-tool-gpu:
    # Development GPU configuration
    volumes:
      - ./videos:/input:ro
      - ./output:/output
      - ./src:/app/src:ro
      - ./fonts:/app/fonts:ro
      - model-cache:/cache
      - ./tests:/app/tests:ro
    
    environment:
      # Debug settings
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - LOG_LEVEL=DEBUG
      
      # Development-specific settings
      - DEVELOPMENT_MODE=true
      - SKIP_MODEL_DOWNLOAD=false
      
      # GPU debugging
      - CUDA_LAUNCH_BLOCKING=1
    
    # Relaxed GPU resource limits for development
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4.0'
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
          memory: 4G
          cpus: '2.0'
    
    # Interactive development command
    command: ["python", "-m", "src.main", "--help"]
    
    # Enable TTY for interactive debugging
    tty: true
    stdin_open: true